<!DOCTYPE html>
<html lang="pt-PT" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Participação Os Mais Mais</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        brand: {
                            blue: '#3b82f6',
                            pink: '#ec4899',
                            dark: '#000000',
                            panel: '#111111'
                        }
                    },
                    fontSize: {
                        'mobile-base': '1.1rem',
                        'mobile-lg': '1.3rem',
                        'mobile-xl': '1.5rem',
                    }
                }
            }
        }
    </script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Poppins', sans-serif;
            transition: background-color 0.3s;
            font-size: 18px;
        }

        body.light { background: #f3f4f6; color: #1f2937; }
        body.dark { background: #000000; color: #e2e8f0; }

        .glass-panel {
            backdrop-filter: blur(15px);
            border-radius: 28px;
            transition: all 0.3s ease;
        }
        
        .light .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            border: 2px solid rgba(255, 255, 255, 0.8);
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }

        .dark .glass-panel {
            background: rgba(20, 20, 20, 0.9);
            border: 2px solid rgba(50, 50, 50, 0.5);
            box-shadow: 0 10px 40px rgba(0,0,0,0.8);
        }

        .app-input {
            width: 100%;
            padding: 18px 20px;
            font-size: 1.2rem;
            border-radius: 16px;
            outline: none;
            transition: all 0.3s;
            font-weight: 600;
        }
        .light .app-input { background: #fff; border: 3px solid #e5e7eb; color: #333; }
        .light .app-input:focus { border-color: #ec4899; }
        .dark .app-input { background: #222; border: 3px solid #333; color: #fff; }
        .dark .app-input:focus { border-color: #3b82f6; }

        .btn-primary {
            background: linear-gradient(135deg, #3b82f6, #ec4899);
            color: white;
            padding: 18px;
            font-size: 1.3rem;
            font-weight: 800;
            border-radius: 18px;
            letter-spacing: 0.5px;
            box-shadow: 0 8px 20px rgba(59, 130, 246, 0.4);
            text-align: center;
            display: block;
            width: 100%;
        }
        .btn-primary:active { transform: scale(0.96); }

        .badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: red;
            color: white;
            border-radius: 50%;
            width: 22px;
            height: 22px;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            animation: pulse 1s infinite;
        }

        /* Notificação Toast Customizada */
        #toast-container {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 9999;
            width: 90%;
            max-width: 400px;
            pointer-events: none;
        }
        .toast-item {
            background: linear-gradient(135deg, #3b82f6, #ec4899);
            color: white;
            padding: 20px;
            border-radius: 24px;
            margin-bottom: 12px;
            box-shadow: 0 15px 30px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            gap: 15px;
            pointer-events: auto;
            animation: slideInDown 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border: 2px solid rgba(255, 255, 255, 0.2);
        }
        @keyframes slideInDown {
            from { transform: translateY(-100%) scale(0.8); opacity: 0; }
            to { transform: translateY(0) scale(1); opacity: 1; }
        }
        .toast-exit {
            animation: slideOutUp 0.5s ease-in forwards;
        }
        @keyframes slideOutUp {
            from { transform: translateY(0) scale(1); opacity: 1; }
            to { transform: translateY(-150%) scale(0.5); opacity: 0; }
        }

        /* Chat Bubbles */
        .chat-bubble {
            max-width: 85%;
            padding: 14px 18px;
            border-radius: 22px;
            margin-bottom: 10px;
            font-size: 1.1rem;
            word-wrap: break-word;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .chat-me { background: #3b82f6; color: white; align-self: flex-end; border-bottom-right-radius: 4px; }
        .chat-partner { background: #222; color: white; align-self: flex-start; border-bottom-left-radius: 4px; border: 1px solid #444; }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="dark">

    <div id="app" class="min-h-screen w-full relative overflow-x-hidden pb-32"></div>

    <!-- Contentor de Notificações (Toasts) -->
    <div id="toast-container"></div>

    <!-- Modals -->
    <div id="loadingOverlay" class="hidden fixed inset-0 z-50 flex flex-col items-center justify-center bg-black/90 backdrop-blur-md">
        <i class="fas fa-shield-alt text-6xl text-brand-pink mb-4 animate-bounce"></i>
        <div class="text-2xl font-bold text-white tracking-widest animate-pulse text-center px-4">
            <span id="loadingText">VERIFICANDO SEGURANÇA...</span>
        </div>
    </div>

    <!-- Modal de Mensagens -->
    <div id="msgModal" class="hidden fixed inset-0 z-40 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4">
        <div class="glass-panel p-6 w-full max-w-md relative">
            <button onclick="closeMsgModal()" class="absolute top-4 right-4 text-gray-500 text-xl"><i class="fas fa-times"></i></button>
            <h2 class="text-2xl font-bold mb-4 text-brand-pink"><i class="fas fa-envelope mr-2"></i> Notificações</h2>
            <div id="msgList" class="space-y-4 max-h-60 overflow-y-auto pr-2"></div>
        </div>
    </div>

    <!-- Modal de Input Admin -->
    <div id="adminInputModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/90 backdrop-blur-sm p-4">
        <div class="glass-panel p-6 w-full max-w-md relative">
            <h2 id="adminInputTitle" class="text-2xl font-bold mb-4 text-white">Enviar Mensagem</h2>
            <textarea id="adminInputText" class="app-input h-32 mb-4" placeholder="Escreva aqui..."></textarea>
            <div class="flex gap-4">
                <button onclick="closeAdminInput()" class="flex-1 py-3 bg-gray-700 rounded-xl font-bold text-white">CANCELAR</button>
                <button onclick="confirmAdminInput()" class="flex-1 py-3 bg-blue-600 rounded-xl font-bold text-white">ENVIAR</button>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIGURAÇÃO ---
        const APP_KEY = 'osmaismais_v15_toasts';
        const SESSION_KEY = 'osmaismais_session_v15';
        const ADMINS = ['Lucas Pedro', 'Bárbara Henrique'];
        const BAD_WORDS = ['palavrão', 'sexo', 'nude', 'idiota', 'burro', 'matar', 'droga', 'xxx', 'porn', 'merda', 'puta'];

        // --- BANCO DE DADOS ---
        function getDatabase() {
            const data = localStorage.getItem(APP_KEY);
            return data ? JSON.parse(data) : { users: [], logs: [], supportBox: [], reports: [], chats: [] };
        }
        function saveDatabase(data) { localStorage.setItem(APP_KEY, JSON.stringify(data)); }

        // --- NOVO SISTEMA DE NOTIFICAÇÃO PERSONALIZADO ---
        function showNotification(title, message) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = 'toast-item';
            toast.innerHTML = `
                <div class="bg-white/20 p-3 rounded-full">
                    <i class="fas fa-bell text-2xl animate-ring"></i>
                </div>
                <div>
                    <h4 class="font-extrabold text-lg">${title}</h4>
                    <p class="text-sm font-medium opacity-90">${message}</p>
                </div>
            `;
            
            // Som de aviso (opcional/simulado)
            if (window.navigator.vibrate) window.navigator.vibrate(200);

            container.appendChild(toast);

            // Remove após 5 segundos
            setTimeout(() => {
                toast.classList.add('toast-exit');
                setTimeout(() => toast.remove(), 500);
            }, 5000);
        }

        // --- AUTO ADMIN ---
        function ensureAdmin() {
            const db = getDatabase();
            const defaultAdmins = [
                { name: 'Bárbara Henrique', pass: '123' },
                { name: 'Lucas Pedro', pass: '123' }
            ];

            defaultAdmins.forEach(admin => {
                const existing = db.users.find(u => u.name === admin.name);
                if (!existing) {
                    db.users.push({
                        id: 'admin_' + admin.name.split(' ')[0].toLowerCase(),
                        name: admin.name, password: admin.pass, role: 'admin',
                        themePref: 'dark', joinedDate: 'Admin Supremo', photo: null, messages: []
                    });
                } else {
                    if (existing.role !== 'admin') existing.role = 'admin';
                }
            });
            saveDatabase(db);
        }

        // --- VARIAVEIS ---
        let currentAdminAction = null;
        let currentTargetId = null;
        let tempReportImage = null;
        let chatInterval = null;

        // --- RENDER ---
        const appDiv = document.getElementById('app');

        function init() {
            ensureAdmin();
            const user = getCurrentUser();
            
            if (user && user.themePref === 'light') document.body.className = 'light';
            else document.body.className = 'dark';

            if (!user) {
                renderLogin();
            } else if (user.role === 'admin') {
                renderAdmin(user);
            } else {
                if (checkIfBanned(user)) renderBanned(user);
                else {
                    renderUser(user);
                    checkNotifications(user);
                }
            }
        }

        function getCurrentUser() {
            const id = localStorage.getItem(SESSION_KEY);
            return id ? getDatabase().users.find(u => u.id === id) : null;
        }

        function checkIfBanned(user) {
            if (!user.banned) return false;
            if (user.banned === true || user.banned.type === 'permanent') return true;
            if (user.banned.expires && new Date(user.banned.expires) > new Date()) return true;
            const db = getDatabase();
            const u = db.users.find(x => x.id === user.id);
            u.banned = false;
            saveDatabase(db);
            return false;
        }

        function checkNotifications(user) {
            const unread = (user.messages || []).filter(m => !m.read);
            if (unread.length > 0) {
                showNotification("Novidade!", `Recebeste ${unread.length} mensagem(ns) da Administração.`);
            }
        }

        // --- TELAS ---
        function renderLogin(isRegister = false) {
            appDiv.innerHTML = `
                <div class="flex flex-col items-center justify-center min-h-screen p-6">
                    <div class="w-full max-w-lg">
                        <div class="glass-panel p-8 fade-in">
                            <h1 class="text-4xl font-extrabold text-center bg-clip-text text-transparent bg-gradient-to-r from-blue-500 to-pink-500 mb-2">Os Mais Mais</h1>
                            <p class="text-center text-lg opacity-60 mb-10">Acesso Restrito</p>
                            <div class="space-y-6">
                                <div><label class="block text-sm font-bold opacity-70 mb-2 ml-1">NOME</label><input type="text" id="name" class="app-input"></div>
                                <div><label class="block text-sm font-bold opacity-70 mb-2 ml-1">SENHA</label><input type="password" id="pass" class="app-input"></div>
                                ${isRegister ? `<div><label class="block text-sm font-bold opacity-70 mb-2 ml-1">IDADE</label><input type="number" id="age" class="app-input"></div>` : ''}
                                <button onclick="${isRegister ? 'tryRegister()' : 'tryLogin()'}" class="btn-primary mt-4">${isRegister ? 'CRIAR CONTA' : 'ENTRAR'}</button>
                            </div>
                            <div class="mt-8 text-center"><button onclick="renderLogin(${!isRegister})" class="text-brand-pink font-bold text-lg p-4 w-full border-2 border-transparent hover:border-brand-pink rounded-xl transition">${isRegister ? 'Já tenho conta' : 'Criar nova conta'}</button></div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderUser(user, tab='perfil') {
            if (chatInterval && tab !== 'parceiro') { clearInterval(chatInterval); chatInterval = null; }
            const isDark = document.body.className.includes('dark');
            const unreadCount = (user.messages || []).filter(m => !m.read).length;
            const content = getUserContent(user, tab);
            
            appDiv.innerHTML = `
                <div class="fixed top-0 w-full z-40 bg-black/80 backdrop-blur p-4 flex justify-between items-center border-b border-gray-800">
                    <span class="text-xl font-bold text-white tracking-tighter">Os Mais Mais</span>
                    <div class="flex gap-4">
                        <button onclick="toggleTheme()" class="w-12 h-12 rounded-full bg-gray-800 text-yellow-400 text-xl border border-gray-700"><i class="fas ${isDark?'fa-sun':'fa-moon'}"></i></button>
                        <button onclick="openMsgModal()" class="w-12 h-12 rounded-full bg-gray-800 text-white text-xl relative border border-gray-700">
                            <i class="fas fa-bell ${unreadCount > 0 ? 'animate-bounce text-yellow-400' : ''}"></i>
                            ${unreadCount > 0 ? `<div class="badge">${unreadCount}</div>` : ''}
                        </button>
                    </div>
                </div>
                
                <div class="pt-28 px-4 max-w-2xl mx-auto pb-48 animate-fade-in">${content}</div>
                
                <div class="fixed bottom-0 w-full z-40 bg-black/95 border-t border-gray-800 pb-4 pt-2 shadow-2xl">
                    <div class="flex items-center gap-3 overflow-x-auto px-4 py-2 no-scrollbar">
                        <button onclick="renderUser(getCurrentUser(), 'perfil')" class="flex-shrink-0 flex items-center gap-2 px-6 py-3 rounded-full ${tab=='perfil'?'bg-gray-800 text-brand-pink border border-brand-pink shadow-[0_0_15px_rgba(236,72,153,0.3)]':'bg-gray-900 text-gray-500 border border-gray-800'} transition-all"><i class="fas fa-user text-xl"></i><span class="font-bold text-sm">PERFIL</span></button>
                        <button onclick="renderUser(getCurrentUser(), 'parceiro')" class="flex-shrink-0 flex items-center gap-2 px-6 py-3 rounded-full ${tab=='parceiro'?'bg-gray-800 text-brand-pink border border-brand-pink shadow-[0_0_15px_rgba(236,72,153,0.3)]':'bg-gray-900 text-gray-500 border border-gray-800'} transition-all"><i class="fas fa-heart text-xl"></i><span class="font-bold text-sm">PARCEIRO</span></button>
                        <button onclick="renderUser(getCurrentUser(), 'suporte')" class="flex-shrink-0 flex items-center gap-2 px-6 py-3 rounded-full ${tab=='suporte'?'bg-gray-800 text-brand-pink border border-brand-pink shadow-[0_0_15px_rgba(236,72,153,0.3)]':'bg-gray-900 text-gray-500 border border-gray-800'} transition-all"><i class="fas fa-headset text-xl"></i><span class="font-bold text-sm">SUPORTE</span></button>
                        <button onclick="renderUser(getCurrentUser(), 'denunciar')" class="flex-shrink-0 flex items-center gap-2 px-6 py-3 rounded-full ${tab=='denunciar'?'bg-red-900/40 text-red-500 border border-red-500 shadow-[0_0_15px_rgba(239,68,68,0.3)]':'bg-gray-900 text-gray-500 border border-gray-800'} transition-all"><i class="fas fa-exclamation-triangle text-xl"></i><span class="font-bold text-sm">DENUNCIAR</span></button>
                        <button onclick="logout()" class="flex-shrink-0 flex items-center gap-2 px-6 py-3 rounded-full bg-red-600 text-white border border-red-500 font-bold ml-2 shadow-lg active:scale-90 transition-transform"><i class="fas fa-sign-out-alt text-xl"></i><span class="text-sm">SAIR</span></button>
                        <div class="w-4 flex-shrink-0"></div>
                    </div>
                </div>
            `;

            if (tab === 'parceiro' && user.partnerId && !user.partnerDisplay) {
                loadChat();
                chatInterval = setInterval(loadChat, 2000);
            }
        }

        function getUserContent(user, tab) {
            if (tab === 'perfil') {
                return `
                    <div class="text-center mb-8">
                        <div class="w-40 h-40 mx-auto rounded-full border-4 border-brand-pink overflow-hidden bg-gray-800 mb-4 relative group shadow-2xl">
                            ${user.photo ? `<img src="${user.photo}" class="w-full h-full object-cover">` : `<div class="w-full h-full flex items-center justify-center text-4xl text-gray-600"><i class="fas fa-camera"></i></div>`}
                            <div class="absolute inset-0 bg-black/50 flex items-center justify-center opacity-0 group-hover:opacity-100 transition"><i class="fas fa-camera text-white text-2xl"></i></div>
                            <input type="file" onchange="uploadPhoto(this)" class="absolute inset-0 opacity-0 cursor-pointer">
                        </div>
                        <h2 class="text-3xl font-bold text-white mb-2 leading-tight">${user.name}</h2>
                        <div class="inline-block px-4 py-2 bg-green-600/20 text-green-500 border border-green-500 font-bold rounded-full text-xs mb-4 uppercase tracking-widest animate-pulse"><i class="fas fa-check-circle mr-1"></i> Membro VIP</div>
                    </div>
                    
                    <div class="space-y-6">
                        <div class="glass-panel p-6 border-l-8 border-brand-blue shadow-lg">
                            <h3 class="text-2xl font-black mb-6 flex items-center gap-2"><i class="fas fa-edit text-brand-blue"></i> EDITAR PERFIL</h3>
                            <div class="space-y-6">
                                <div><label class="block text-sm font-black opacity-40 mb-2 tracking-tighter">NOME PÚBLICO</label><input id="newName" value="${user.name}" class="app-input"></div>
                                <div><label class="block text-sm font-black opacity-40 mb-2 tracking-tighter">EMAIL (TROCA MENSAL)</label><input id="newEmail" value="${user.email||''}" class="app-input" placeholder="exemplo@mail.com"></div>
                                <div><label class="block text-sm font-black opacity-40 mb-2 tracking-tighter">SEGURANÇA (SENHA)</label><input id="newPass" type="password" class="app-input" placeholder="••••••••"></div>
                                <button onclick="saveProfileChanges()" class="btn-primary flex items-center justify-center gap-3">GUARDAR ALTERAÇÕES <i class="fas fa-save"></i></button>
                            </div>
                        </div>
                    </div>
                `;
            }
            if (tab === 'parceiro') {
                if (user.partnerId && !user.partnerDisplay) {
                    const db = getDatabase();
                    const partner = db.users.find(u => u.id === user.partnerId);
                    const partnerName = partner ? partner.name : "Removido";
                    return `
                        <div class="glass-panel p-6 border-2 border-brand-pink h-[calc(100vh-280px)] flex flex-col shadow-2xl">
                            <div class="flex items-center justify-between border-b border-gray-700 pb-4 mb-4">
                                <div class="flex items-center gap-3">
                                    <div class="w-14 h-14 rounded-full bg-gray-700 overflow-hidden border-2 border-brand-pink">
                                        ${partner && partner.photo ? `<img src="${partner.photo}" class="w-full h-full object-cover">` : '<div class="w-full h-full flex items-center justify-center"><i class="fas fa-user text-xl"></i></div>'}
                                    </div>
                                    <div>
                                        <h2 class="text-xl font-black text-white">${partnerName}</h2>
                                        <p class="text-xs text-green-400 font-bold flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-green-500 animate-ping"></span> CHAT ATIVO</p>
                                    </div>
                                </div>
                                <button onclick="removePartner()" class="text-red-500 bg-red-500/10 p-2 rounded-xl border border-red-500/30 active:bg-red-500 active:text-white transition-all"><i class="fas fa-user-slash"></i></button>
                            </div>
                            <div id="chatArea" class="flex-1 overflow-y-auto mb-4 p-4 bg-black/40 rounded-3xl flex flex-col gap-2 no-scrollbar border border-gray-800/50"></div>
                            <div class="flex gap-2">
                                <input id="chatInput" class="app-input !py-4 !rounded-3xl" placeholder="Escreve uma mensagem...">
                                <button onclick="sendChatMessage()" class="bg-brand-blue text-white w-16 rounded-3xl flex items-center justify-center text-2xl shadow-lg active:scale-90 transition-transform"><i class="fas fa-paper-plane"></i></button>
                            </div>
                        </div>
                    `;
                }
                if (user.partnerDisplay) {
                    return `
                         <div class="glass-panel p-10 text-center border-2 border-gray-600 shadow-2xl">
                            <i class="fas fa-heart text-7xl text-gray-500 mb-6 drop-shadow-lg"></i>
                            <h2 class="text-4xl font-black mb-2 text-white">${user.partnerDisplay.name}</h2>
                            <p class="text-2xl font-bold opacity-70 mb-8">${user.partnerDisplay.age} anos</p>
                            <div class="bg-yellow-500/10 border border-yellow-500/50 p-5 rounded-3xl mb-10">
                                <p class="text-yellow-500 text-sm font-black uppercase tracking-tighter"><i class="fas fa-exclamation-triangle mr-1"></i> Perfil Visual</p>
                                <p class="text-gray-400 text-xs mt-2">Chat desativado. Conecta-te com um utilizador real para conversar.</p>
                            </div>
                            <button onclick="removePartner()" class="w-full py-5 bg-red-600/20 text-red-500 border-2 border-red-600/50 rounded-3xl font-black text-xl active:bg-red-600 active:text-white transition-all">REMOVER PARCEIRO</button>
                        </div>
                    `;
                }
                return `
                    <div class="glass-panel p-8 text-center shadow-2xl border-t-8 border-brand-pink">
                        <i class="fas fa-search-heart text-7xl text-brand-pink mb-6"></i>
                        <h2 class="text-3xl font-black mb-4">ENCONTRAR PAR</h2>
                        <p class="text-gray-400 mb-8 text-sm leading-relaxed">Digita o <b>nome exato</b> para te conectares ou adiciona alguém visualmente.</p>
                        <input id="partnerSearchName" class="app-input mb-4 text-center" placeholder="Ex: Lucas Pedro">
                        <button onclick="linkPartner()" class="btn-primary">CONECTAR AGORA</button>
                    </div>
                `;
            }
            if (tab === 'suporte') {
                return `
                    <div class="glass-panel p-6 text-center border-t-8 border-gray-700 shadow-2xl">
                        <div class="mb-10 p-6 bg-red-600/10 rounded-3xl border border-red-600/30">
                            <i class="fas fa-user-secret text-6xl text-red-500 mb-4"></i>
                            <h3 class="text-2xl font-black text-red-500 mb-2 uppercase tracking-tighter">Atenção</h3>
                            <p class="text-sm font-bold opacity-80 leading-relaxed italic">"Os administradores são invisíveis. Nunca saberás quem são. Eles vigiam e punem."</p>
                        </div>
                        <h2 class="text-2xl font-black mb-6">CENTRAL DE APOIO</h2>
                        <textarea id="supportMsg" class="app-input mb-4 h-40" placeholder="Como podemos ajudar?"></textarea>
                        <button onclick="sendSupportMessage()" class="btn-primary">ENVIAR MENSAGEM</button>
                    </div>
                `;
            }
            if (tab === 'denunciar') {
                return `
                    <div class="glass-panel p-6 text-center border-t-8 border-red-600 shadow-2xl">
                        <i class="fas fa-bullhorn text-6xl text-red-600 mb-4"></i>
                        <h2 class="text-3xl font-black mb-4 text-red-500">DENUNCIAR</h2>
                        <p class="text-gray-400 mb-8 text-sm">Viste abusos? Manda um print. O Robô e a Administração vão agir imediatamente.</p>
                        <textarea id="reportDesc" class="app-input mb-6 h-32" placeholder="O que aconteceu e quem foi?"></textarea>
                        <div class="mb-8">
                            <label class="block w-full p-6 border-4 border-dashed border-gray-700 rounded-3xl cursor-pointer hover:border-brand-pink transition-all bg-gray-900/50">
                                <i class="fas fa-file-image text-3xl text-gray-500 mb-3"></i><br>
                                <span id="fileName" class="text-sm font-black text-gray-500">ANEXAR PRINT / FOTO</span>
                                <input type="file" id="reportFile" class="hidden" accept="image/*" onchange="previewReportImage(this)">
                            </label>
                            <img id="reportPreview" class="w-full mt-6 rounded-3xl hidden border-2 border-red-600 shadow-2xl">
                        </div>
                        <button onclick="sendReport()" class="w-full py-5 bg-red-600 text-white rounded-3xl font-black text-xl shadow-red-600/40 shadow-xl active:scale-95 transition-transform">ENVIAR DENÚNCIA</button>
                    </div>
                `;
            }
        }

        function renderAdmin(admin) {
            const db = getDatabase();
            const users = db.users.filter(u => u.role !== 'admin');
            const reports = db.reports || [];
            const supportMsgs = db.supportBox || [];
            
            appDiv.innerHTML = `
                <div class="min-h-screen bg-black text-white p-4 pb-40 animate-fade-in">
                    <div class="flex justify-between items-center mb-10 pt-4 px-2">
                        <div>
                            <h1 class="text-3xl font-black text-red-500 tracking-tighter uppercase">Painel de Controlo</h1>
                            <p class="text-xs text-gray-500 font-bold uppercase tracking-widest">Acesso de Administrador Supremo</p>
                        </div>
                        <button onclick="logout()" class="px-6 py-3 bg-red-600 rounded-2xl font-black text-xs shadow-lg shadow-red-600/30">SAIR</button>
                    </div>

                    <!-- DENÚNCIAS -->
                    <div class="mb-10 p-6 bg-red-950/20 border-2 border-red-600/50 rounded-3xl shadow-red-600/10 shadow-xl">
                        <h3 class="text-xl font-black text-red-500 mb-6 flex items-center gap-2"><i class="fas fa-skull"></i> DENÚNCIAS (${reports.length})</h3>
                        <div class="space-y-6 max-h-96 overflow-y-auto no-scrollbar pr-1">
                            ${reports.length === 0 ? '<p class="text-center text-gray-600 py-10 font-bold uppercase text-xs">Sem denúncias por agora</p>' : ''}
                            ${reports.map((rep, idx) => `
                                <div class="bg-gray-900/50 p-5 rounded-3xl border border-red-600/30">
                                    <div class="flex justify-between items-center mb-3">
                                        <span class="font-black text-xs uppercase text-gray-400">Repórter: ${rep.reporterName}</span>
                                        <span class="text-[10px] font-bold text-gray-600">${rep.date}</span>
                                    </div>
                                    <p class="text-sm font-bold text-gray-200 mb-4 leading-relaxed">${rep.description}</p>
                                    ${rep.image ? `<img src="${rep.image}" class="w-full rounded-2xl mb-4 border border-gray-700 shadow-xl" onclick="window.open(this.src)">` : ''}
                                    <button onclick="deleteReport(${idx})" class="w-full py-3 bg-gray-800 text-gray-400 rounded-2xl font-black text-xs border border-gray-700">MARCAR COMO RESOLVIDA</button>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <!-- LISTA DE ALVOS -->
                    <h3 class="text-2xl font-black text-gray-600 mb-6 px-2 uppercase tracking-tighter">Gestão de Participantes</h3>
                    <div class="space-y-6">
                        ${users.map(u => {
                            let partnerInfo = 'Solteiro(a)';
                            if (u.partnerId) { const p = db.users.find(x => x.id === u.partnerId); partnerInfo = p ? p.name : 'Vazio'; }
                            else if (u.partnerDisplay) partnerInfo = `${u.partnerDisplay.name} (Visual)`;

                            return `
                                <div class="bg-gray-900 p-6 rounded-3xl border border-gray-800 shadow-xl">
                                    <div class="flex justify-between items-start mb-6">
                                        <div class="flex items-center gap-4">
                                            <div class="w-16 h-16 rounded-full overflow-hidden border-2 ${u.banned?'border-red-600 grayscale':'border-brand-blue'}">
                                                <img src="${u.photo || `https://api.dicebear.com/7.x/avataaars/svg?seed=${u.name}`}" class="w-full h-full object-cover">
                                            </div>
                                            <div>
                                                <h3 class="text-2xl font-black ${u.banned?'text-red-500 line-through':'text-white'} leading-none mb-1">${u.name}</h3>
                                                <p class="text-xs font-black text-yellow-500 tracking-widest"><i class="fas fa-lock mr-1"></i> ${u.password}</p>
                                                <p class="text-[10px] font-bold text-brand-blue mt-1 uppercase">Par: ${partnerInfo}</p>
                                            </div>
                                        </div>
                                        ${u.banned ? '<span class="px-3 py-1 bg-red-600 text-white text-[10px] font-black rounded-full shadow-lg shadow-red-600/40">BLOQUEADO</span>' : ''}
                                    </div>
                                    <div class="grid grid-cols-2 gap-3">
                                        <button onclick="openAdminInput('send', null, '${u.id}')" class="col-span-2 py-4 bg-brand-blue/10 text-brand-blue border border-brand-blue/30 rounded-2xl font-black text-xs active:bg-brand-blue active:text-white transition-all">NOTIFICAR UTILIZADOR</button>
                                        ${!u.banned ? `
                                            <button onclick="banUser('${u.id}', 1)" class="py-4 bg-red-950/30 text-red-400 border border-red-600/30 rounded-2xl font-black text-[10px]">BAN 24H</button>
                                            <button onclick="banUser('${u.id}', 0)" class="py-4 bg-red-600 text-white rounded-2xl font-black text-[10px] shadow-lg shadow-red-600/20">BAN ETERNO</button>
                                        ` : `<button onclick="unbanUser('${u.id}')" class="col-span-2 py-4 bg-green-600 text-white rounded-2xl font-black text-xs shadow-lg shadow-green-600/20">DESBLOQUEAR ACESSO</button>`}
                                        <button onclick="deletePhoto('${u.id}')" class="col-span-2 py-3 bg-gray-800 text-gray-500 rounded-2xl font-black text-[10px] border border-gray-700">APAGAR FOTO DE PERFIL</button>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        }

        function renderBanned(user) {
            appDiv.innerHTML = `<div class="min-h-screen flex items-center justify-center bg-red-950 p-8 text-center text-white"><div><i class="fas fa-hand-paper text-8xl mb-8 text-red-500 animate-pulse"></i><h1 class="text-5xl font-black mb-4 tracking-tighter">ACESSO NEGADO</h1><p class="text-xl font-bold opacity-70 mb-10 leading-relaxed">A tua conta foi suspensa permanentemente pelo Robô de Segurança ou pela Administração.</p><button onclick="logout()" class="w-full py-6 bg-black rounded-3xl text-2xl font-black border-2 border-red-600 shadow-red-600/20 shadow-xl">SAIR DO SITE</button></div></div>`;
        }

        // --- LÓGICA DE AÇÕES ---
        window.saveProfileChanges = function() {
            const n = document.getElementById('newName').value.trim();
            const e = document.getElementById('newEmail').value.trim();
            const p = document.getElementById('newPass').value.trim();
            if(!n) return alert("O nome não pode estar vazio.");
            const db = getDatabase(); const u = db.users.find(x => x.id === getCurrentUser().id);
            if(BAD_WORDS.some(w => n.toLowerCase().includes(w))) { u.banned = true; saveDatabase(db); init(); return; }
            if(db.users.find(x => x.name === n && x.id !== u.id)) return alert("Este nome já existe.");
            if(e && e !== u.email) {
                const now = Date.now();
                if(u.lastEmailUpdate && (now - new Date(u.lastEmailUpdate).getTime() < 2592000000)) return alert("Só podes mudar o email 1 vez por mês.");
                u.email = e; u.lastEmailUpdate = new Date().toISOString();
            }
            u.name = n; if(p) u.password = p;
            saveDatabase(db); showNotification("Sucesso", "Perfil atualizado com sucesso!"); renderUser(u, 'perfil');
        };

        window.linkPartner = function() {
            const target = document.getElementById('partnerSearchName').value.trim();
            if(!target) return;
            const db = getDatabase(); const u = db.users.find(x => x.id === getCurrentUser().id);
            const found = db.users.find(x => x.name === target);
            if(found) {
                if(found.id === u.id) return alert("Não podes ser o teu próprio par.");
                if(found.partnerId) return alert("Este utilizador já tem par.");
                u.partnerId = found.id; found.partnerId = u.id; u.partnerDisplay = null;
                saveDatabase(db); showNotification("Conectado!", "Parceiro real conectado."); renderUser(u, 'parceiro');
            } else {
                if(confirm(`"${target}" não foi encontrado. Queres adicionar apenas visualmente?`)) {
                    const age = prompt("Idade do parceiro:");
                    if(age) { u.partnerDisplay = {name: target, age}; u.partnerId = null; saveDatabase(db); renderUser(u, 'parceiro'); }
                }
            }
        };

        window.sendChatMessage = function() {
            const t = document.getElementById('chatInput').value.trim();
            if(!t) return;
            const u = getCurrentUser(); const db = getDatabase();
            db.chats.push({ fromId: u.id, toId: u.partnerId, text: t, timestamp: Date.now() });
            saveDatabase(db); document.getElementById('chatInput').value = ''; loadChat();
        };

        window.loadChat = function() {
            const u = getCurrentUser(); if(!u || !u.partnerId) return;
            const db = getDatabase(); const area = document.getElementById('chatArea'); if(!area) return;
            const msgs = db.chats.filter(c => (c.fromId === u.id && c.toId === u.partnerId) || (c.fromId === u.partnerId && c.toId === u.id)).sort((a,b) => a.timestamp - b.timestamp);
            let html = msgs.length ? msgs.map(m => `<div class="flex ${m.fromId === u.id ? 'justify-end' : 'justify-start'}"><div class="chat-bubble ${m.fromId === u.id ? 'chat-me' : 'chat-partner'}">${m.text}</div></div>`).join('') : '<p class="text-center text-gray-600 text-xs mt-10 uppercase font-black tracking-widest">Inicia a conversa...</p>';
            if(area.innerHTML !== html) { area.innerHTML = html; area.scrollTop = area.scrollHeight; }
        };

        window.sendSupportMessage = function() {
            const t = document.getElementById('supportMsg').value.trim();
            if(!t) return;
            const db = getDatabase(); db.supportBox.unshift({ userName: getCurrentUser().name, userId: getCurrentUser().id, text: t, date: new Date().toLocaleString(), resolved: false });
            saveDatabase(db); document.getElementById('supportMsg').value = ''; showNotification("Enviado", "A Administração oculta recebeu a tua mensagem.");
        };

        window.sendReport = function() {
            const d = document.getElementById('reportDesc').value.trim();
            if(!d && !tempReportImage) return alert("Descreve o erro ou anexa uma foto.");
            const db = getDatabase(); db.reports.unshift({ reporterName: getCurrentUser().name, description: d, image: tempReportImage, date: new Date().toLocaleString() });
            saveDatabase(db); tempReportImage = null; showNotification("Denúncia Enviada", "Obrigado por ajudares a manter a ordem."); renderUser(getCurrentUser(), 'denunciar');
        };

        // --- SISTEMAS ADMIN ---
        window.openAdminInput = function(action, msgIdx, userId) { currentAdminAction = action; currentTargetId = userId; window.currentMsgIdx = msgIdx; document.getElementById('adminInputModal').classList.remove('hidden'); document.getElementById('adminInputText').value = ''; };
        window.closeAdminInput = function() { document.getElementById('adminInputModal').classList.add('hidden'); };
        window.confirmAdminInput = function() {
            const t = document.getElementById('adminInputText').value.trim();
            if(!t) return;
            const db = getDatabase(); const u = db.users.find(x => x.id === currentTargetId);
            if(u) {
                if(!u.messages) u.messages = [];
                u.messages.push({ from: 'Administração', text: t, date: new Date().toLocaleString(), read: false });
                if(currentAdminAction === 'reply' && window.currentMsgIdx !== null) db.supportBox[window.currentMsgIdx].resolved = true;
                saveDatabase(db); showNotification("Admin", "Mensagem enviada com sucesso!"); closeAdminInput(); renderAdmin(getCurrentUser());
            }
        };

        window.tryLogin = function() {
            const n = document.getElementById('name').value.trim();
            const p = document.getElementById('pass').value.trim();
            const db = getDatabase(); const u = db.users.find(x => x.name === n && x.password === p);
            if(u) { if(checkIfBanned(u)) { renderBanned(u); return; } localStorage.setItem(SESSION_KEY, u.id); init(); } else alert("Dados incorretos.");
        };

        window.tryRegister = function() {
            const n = document.getElementById('name').value.trim();
            const p = document.getElementById('pass').value.trim();
            const a = document.getElementById('age').value;
            if(!n || !p || !a) return alert("Preenche tudo!");
            if(BAD_WORDS.some(w => n.toLowerCase().includes(w))) return alert("Nome proibido.");
            const db = getDatabase(); if(db.users.find(x => x.name === n)) return alert("Nome ocupado.");
            const nu = { id: Date.now().toString(), name: n, password: p, age: a, role: ADMINS.includes(n)?'admin':'user', themePref:'dark', banned: false, messages: [], photo: null };
            db.users.push(nu); saveDatabase(db); localStorage.setItem(SESSION_KEY, nu.id); init();
        };

        window.logout = function() { localStorage.removeItem(SESSION_KEY); if(chatInterval) clearInterval(chatInterval); init(); };
        window.uploadPhoto = function(i) { if(i.files[0]) { const r = new FileReader(); r.onload = (e) => { const db=getDatabase(); const u=db.users.find(x=>x.id===getCurrentUser().id); u.photo=e.target.result; saveDatabase(db); renderUser(u); }; r.readAsDataURL(i.files[0]); } };
        window.previewReportImage = function(i) { if(i.files[0]) { const r = new FileReader(); r.onload = (e) => { tempReportImage = e.target.result; const p = document.getElementById('reportPreview'); p.src = e.target.result; p.classList.remove('hidden'); }; r.readAsDataURL(i.files[0]); } };
        window.deleteReport = (i) => { const db=getDatabase(); db.reports.splice(i,1); saveDatabase(db); renderAdmin(getCurrentUser()); };
        window.banUser = (id,t) => { const db=getDatabase(); const u=db.users.find(x=>x.id===id); u.banned=t===1?{expires:Date.now()+86400000}:{type:'permanent'}; saveDatabase(db); renderAdmin(getCurrentUser()); };
        window.unbanUser = (id) => { const db=getDatabase(); db.users.find(x=>x.id===id).banned=false; saveDatabase(db); renderAdmin(getCurrentUser()); };
        window.deletePhoto = (id) => { const db=getDatabase(); db.users.find(x=>x.id===id).photo=null; saveDatabase(db); renderAdmin(getCurrentUser()); };
        window.toggleTheme = () => { const db=getDatabase(); const u=db.users.find(x=>x.id===getCurrentUser().id); u.themePref = u.themePref === 'dark' ? 'light' : 'dark'; saveDatabase(db); init(); };
        window.closeMsgModal = () => { document.getElementById('msgModal').classList.add('hidden'); const db=getDatabase(); const u=db.users.find(x=>x.id===getCurrentUser().id); u.messages.forEach(m=>m.read=true); saveDatabase(db); renderUser(u); };
        window.openMsgModal = () => { 
            const u = getCurrentUser(); const l = document.getElementById('msgList'); 
            l.innerHTML = u.messages.length ? u.messages.map(m => `<div class="bg-gray-800 p-5 rounded-3xl border-l-4 ${m.read?'border-gray-600':'border-brand-pink'}"><p class="font-black text-brand-pink text-xs uppercase tracking-widest mb-1">${m.from}</p><p class="text-white font-bold leading-snug">${m.text}</p><p class="text-[9px] text-gray-500 mt-2">${m.date}</p></div>`).join('') : '<p class="text-center text-gray-600 py-10 font-bold uppercase text-xs tracking-widest">Sem avisos</p>';
            document.getElementById('msgModal').classList.remove('hidden');
        };

        init();
    </script>
</body>
</html>